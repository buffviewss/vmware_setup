# ===== Core / Global =====
mixed-port: 7890            # cổng proxy (HTTP+SOCKS) cho client nào muốn dùng trực tiếp
allow-lan: true
mode: Rule
log-level: info
external-controller: 0.0.0.0:9090
ipv6: false                 # tránh rò IPv6 khi upstream không hỗ trợ

# ===== Upstream SOCKS (TCP-only) nhưng vẫn ôm UDP nhờ udp-over-tcp =====
proxies:
  - name: socks-proxy
    type: socks5
    server: 217.177.34.19
    port: 6012
    username: eyvizq4mf8n3
    password: 6jo0C8dNSfrtkclt
    udp: true               # Mihomo nhận UDP
    udp-over-tcp: true      # bọc UDP -> TCP để đẩy qua SOCKS TCP-only

# ===== Điều hướng =====
proxy-groups:
  - name: FINAL
    type: select
    proxies: [socks-proxy, DIRECT]

rules:
  # bypass nội bộ/LAN
  - DOMAIN-SUFFIX,lan,DIRECT
  - IP-CIDR,127.0.0.0/8,DIRECT
  - IP-CIDR,10.0.0.0/8,DIRECT
  - IP-CIDR,172.16.0.0/12,DIRECT
  - IP-CIDR,192.168.0.0/16,DIRECT
  - MATCH,FINAL

# ===== TUN (auto + strict route, không chặn UDP) =====
tun:
  enable: true
  stack: system
  auto-route: true
  strict-route: true
  auto-detect-interface: true
  dns-hijack:
    - any:53               # kéo toàn bộ DNS về Mihomo, không cần bật DNS Proxy

# ===== Sniffer (an toàn để ON, có thể tắt nếu không cần) =====
sniffer:
  enable: true
  sniffing: [tls, http]
  force-dns-mapping: true
  parse-pure-ip: true

# ===== DNS (DoH) - tránh xung đột với Dnsmasq =====
dns:
  enable: true
  ipv6: false
  enhanced-mode: fake-ip           # ổn định cho TUN
  listen: 127.0.0.1:1053           # lắng trên loopback để không đụng Dnsmasq (cổng 53)
  default-nameserver: [1.1.1.1, 8.8.8.8]
  nameserver:
    - https://1.1.1.1/dns-query
    - https://dns.google/dns-query
  fallback: []
  fallback-filter:
    geoip: true
    ipcidr: [0.0.0.0/32]
